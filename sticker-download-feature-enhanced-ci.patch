From 50ba2263109009cc0dc1dc250d170927368e9e42 Mon Sep 17 00:00:00 2001
From: AI Assistant <ai-assistant@example.com>
Date: Fri, 17 Oct 2025 13:36:24 +0800
Subject: [PATCH 1/2] =?UTF-8?q?feat:=20=E6=B7=BB=E5=8A=A0=E8=B4=B4?=
 =?UTF-8?q?=E7=BA=B8=E5=8C=85=E4=B8=8B=E8=BD=BD=E5=8A=9F=E8=83=BD?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

- åœ¨StickerServiceä¸­æ·»åŠ è´´çº¸åŒ…ä¸‹è½½åŠŸèƒ½
- æ”¯æŒæ‰¹é‡ä¸‹è½½è´´çº¸åˆ°æœ¬åœ°è®¾å¤‡
- æ·»åŠ ä¸‹è½½è¿›åº¦è·Ÿè¸ªå’Œé”™è¯¯å¤„ç†
- æ”¯æŒå¤šç§è´´çº¸æ ¼å¼(.png, .tgs, .mp4)
- æ›´æ–°TelegramBotBackgroundServiceæ”¯æŒä¸‹è½½å‘½ä»¤
- å®Œå–„README.mdæ–‡æ¡£å’Œä½¿ç”¨è¯´æ˜
- æ·»åŠ /downloadå’Œ/help_downloadå¿«æ·å‘½ä»¤

Co-authored-by: dakou <dakou@iflow.cn>
---
 README.md                                   |  30 +++
 src/Service/StickerService.cs               | 229 ++++++++++++++++++++
 src/Service/TelegramBotBackgroundService.cs |  10 +
 3 files changed, 269 insertions(+)

diff --git a/README.md b/README.md
index 0e68c09..535b1c0 100644
--- a/README.md
+++ b/README.md
@@ -8,6 +8,7 @@
 ## âœ¨ é¡¹ç›®äº®ç‚¹
 
 - ğŸ’ æ”¯æŒ Telegram è´´çº¸ å’Œ è¡¨æƒ… çš„å…‹éš†æ“ä½œ
+- ğŸ’¾ æ”¯æŒè´´çº¸åŒ…æ‰¹é‡ä¸‹è½½åˆ°æœ¬åœ°è®¾å¤‡
 - ğŸ§  æ™ºèƒ½è¯†åˆ«ç”¨æˆ·è¾“å…¥æ ¼å¼
 - ğŸ”„ æ”¯æŒå‘½ä»¤æ ¼å¼è§£æè‡ªåŠ¨å…‹éš†
 - âš™ï¸ åŸºäº .NET 9.0 æ„å»ºï¼Œæ€§èƒ½å¯é 
@@ -61,4 +62,33 @@
 è¯·ç¡®ä¿ä¿¡æ¯å¡«å†™æ­£ç¡®ï¼Œä»¥ä¾¿ç¨‹åºé¡ºåˆ©å…‹éš†å“¦ï½ ğŸš€
 ```
 
+### è´´çº¸åŒ…ä¸‹è½½åŠŸèƒ½
+æ‚¨è¿˜å¯ä»¥ä¸‹è½½æŒ‡å®šè´´çº¸åŒ…ä¸­çš„æ‰€æœ‰è´´çº¸åˆ°æœ¬åœ°è®¾å¤‡ï¼š
+
+```
+ğŸ’¾ è´´çº¸åŒ…ä¸‹è½½ä½¿ç”¨è¯´æ˜ ğŸ’¾
+
+æ‚¨å¯ä»¥ä¸‹è½½æŒ‡å®šè´´çº¸åŒ…ä¸­çš„æ‰€æœ‰è´´çº¸åˆ°æœ¬åœ°è®¾å¤‡ã€‚ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š
+
+ä¸‹è½½#ç›®æ ‡æ–‡ä»¶å¤¹è·¯å¾„#è´´çº¸åŒ…é“¾æ¥
+
+ä¾‹å¦‚ï¼š
+ä¸‹è½½#./Downloads/my-stickers#https://t.me/addstickers/animals_collection
+
+ğŸ”¹ ä¸‹è½½ï¼šå‘½ä»¤å‰ç¼€ï¼Œè§¦å‘ä¸‹è½½æ“ä½œ
+ğŸ”¹ ç›®æ ‡æ–‡ä»¶å¤¹è·¯å¾„ï¼šå­˜æ”¾ä¸‹è½½è´´çº¸çš„æœ¬åœ°æ–‡ä»¶å¤¹è·¯å¾„
+ğŸ”¹ è´´çº¸åŒ…é“¾æ¥ï¼šè¦ä¸‹è½½çš„Telegramè´´çº¸åŒ…é“¾æ¥
+
+æ³¨æ„ï¼š
+- è¯·ç¡®ä¿æœ‰è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´å­˜å‚¨è´´çº¸æ–‡ä»¶
+- å¤§å‹è´´çº¸åŒ…å¯èƒ½éœ€è¦è¾ƒé•¿çš„ä¸‹è½½æ—¶é—´
+- å»ºè®®åœ¨ç½‘ç»œè‰¯å¥½çš„ç¯å¢ƒä¸‹è¿›è¡Œæ“ä½œ
+```
+
+### å¿«æ·å‘½ä»¤
+- `/start` - å¯åŠ¨æœºå™¨äºº
+- `/info` - æŸ¥çœ‹é¡¹ç›®ä¿¡æ¯
+- `/download` - ä¸‹è½½è´´çº¸åŒ…
+- `/help_download` - æŸ¥çœ‹ä¸‹è½½å¸®åŠ©
+
 ------
diff --git a/src/Service/StickerService.cs b/src/Service/StickerService.cs
index 33dfada..4d48bba 100644
--- a/src/Service/StickerService.cs
+++ b/src/Service/StickerService.cs
@@ -4,11 +4,13 @@ public class StickerService
 {
     private readonly ILogger<StickerService> _logger;
     private readonly MessageService _messageService;
+    private readonly HttpClient _httpClient;
 
     public StickerService(ILogger<StickerService> logger, MessageService messageService)
     {
         _logger = logger;
         _messageService = messageService;
+        _httpClient = new HttpClient(); // ç”¨äºä¸‹è½½è´´çº¸æ–‡ä»¶çš„HttpClientå®ä¾‹
     }
 
     public async Task SendStickerInstructionsAsync(Bot bot, Telegram.Bot.Types.Message msg)
@@ -231,4 +233,231 @@ public class StickerService
         ValidatePackName(packName);
         return packName;
     }
+
+    /// <summary>
+    /// å‘é€è´´çº¸åŒ…ä¸‹è½½ä½¿ç”¨è¯´æ˜
+    /// </summary>
+    public async Task SendDownloadInstructionsAsync(Bot bot, Telegram.Bot.Types.Message msg)
+    {
+        var messageText = new StringBuilder()
+            .AppendLine("ğŸ’¾ <b>è´´çº¸åŒ…ä¸‹è½½ä½¿ç”¨è¯´æ˜</b> ğŸ’¾")
+            .AppendLine()
+            .AppendLine("æ‚¨å¯ä»¥ä¸‹è½½æŒ‡å®šè´´çº¸åŒ…ä¸­çš„æ‰€æœ‰è´´çº¸åˆ°æœ¬åœ°è®¾å¤‡ã€‚ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š")
+            .AppendLine()
+            .AppendLine("<code>ä¸‹è½½#ç›®æ ‡æ–‡ä»¶å¤¹è·¯å¾„#è´´çº¸åŒ…é“¾æ¥</code>")
+            .AppendLine()
+            .AppendLine("ä¾‹å¦‚ï¼š")
+            .AppendLine("<code>ä¸‹è½½#./Downloads/my-stickers#https://t.me/addstickers/animals_collection</code>")
+            .AppendLine()
+            .AppendLine("ğŸ”¹ <b>ä¸‹è½½</b>ï¼šå‘½ä»¤å‰ç¼€ï¼Œè§¦å‘ä¸‹è½½æ“ä½œ")
+            .AppendLine("ğŸ”¹ <b>ç›®æ ‡æ–‡ä»¶å¤¹è·¯å¾„</b>ï¼šå­˜æ”¾ä¸‹è½½è´´çº¸çš„æœ¬åœ°æ–‡ä»¶å¤¹è·¯å¾„")
+            .AppendLine("ğŸ”¹ <b>è´´çº¸åŒ…é“¾æ¥</b>ï¼šè¦ä¸‹è½½çš„Telegramè´´çº¸åŒ…é“¾æ¥")
+            .AppendLine()
+            .AppendLine("æ³¨æ„ï¼š")
+            .AppendLine("- è¯·ç¡®ä¿æœ‰è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´å­˜å‚¨è´´çº¸æ–‡ä»¶")
+            .AppendLine("- å¤§å‹è´´çº¸åŒ…å¯èƒ½éœ€è¦è¾ƒé•¿çš„ä¸‹è½½æ—¶é—´")
+            .AppendLine("- å»ºè®®åœ¨ç½‘ç»œè‰¯å¥½çš„ç¯å¢ƒä¸‹è¿›è¡Œæ“ä½œ")
+            .ToString();
+
+        await _messageService.SendMessageAsync(bot, msg.Chat.Id, messageText, replyParameters: msg);
+    }
+
+    /// <summary>
+    /// å¤„ç†è´´çº¸åŒ…ä¸‹è½½å‘½ä»¤
+    /// </summary>
+    public async Task HandleDownloadCommandAsync(Bot bot, Telegram.Bot.Types.Message msg)
+    {
+        try
+        {
+            string[] parts = msg.Text.Split('#');
+
+            if (parts.Length != 3)
+            {
+                var errorMsg = new StringBuilder()
+                    .AppendLine("æ ¼å¼é”™è¯¯ï¼è¯·ä½¿ç”¨æ­£ç¡®çš„æ ¼å¼ï¼š")
+                    .Append("ä¸‹è½½#ç›®æ ‡æ–‡ä»¶å¤¹è·¯å¾„#è´´çº¸åŒ…é“¾æ¥")
+                    .ToString();
+
+                await _messageService.SendMessageAsync(bot, msg.Chat.Id, errorMsg, replyParameters: msg);
+                return;
+            }
+
+            string downloadDirectory = parts[1].Trim();
+            string stickerUrl = parts[2];
+
+            if (!stickerUrl.StartsWith("https://t.me/add"))
+            {
+                await _messageService.SendMessageAsync(bot, msg.Chat.Id,
+                    "è´´çº¸é“¾æ¥æ ¼å¼é”™è¯¯ï¼é“¾æ¥åº”è¯¥ä»¥ https://t.me/add å¼€å¤´",
+                    replyParameters: msg);
+                return;
+            }
+
+            string stickerSetName = stickerUrl
+                .Replace("https://t.me/addstickers/", "")
+                .Replace("https://t.me/addemoji/", "");
+
+            var statusMessage = $"ğŸ’¾ æ­£åœ¨å‡†å¤‡ä¸‹è½½è´´çº¸åŒ…ï¼Œè¯·ç¨å€™...\næ­¤è¿‡ç¨‹å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿï¼Œå–å†³äºè´´çº¸æ•°é‡å’Œå¤§å°ã€‚";
+            var statusMessageId = await _messageService.SendMessageAsync(bot, msg.Chat.Id, statusMessage);
+
+            _ = Task.Run(async () => await ProcessDownloadStickerTaskAsync(
+                bot, msg, statusMessageId, stickerSetName, downloadDirectory));
+        }
+        catch (Exception ex)
+        {
+            var errorBuilder = $"[é”™è¯¯] å‘ç”Ÿå¼‚å¸¸: {ex.Message}";
+            _logger.LogError(ex, "å¤„ç†ä¸‹è½½å‘½ä»¤æ—¶å‘ç”Ÿå¼‚å¸¸");
+            await _messageService.SendMessageAsync(bot, msg.Chat.Id, errorBuilder);
+        }
+    }
+
+    /// <summary>
+    /// å¼‚æ­¥å¤„ç†è´´çº¸åŒ…ä¸‹è½½ä»»åŠ¡
+    /// </summary>
+    private async Task ProcessDownloadStickerTaskAsync(
+        Bot bot,
+        Telegram.Bot.Types.Message msg,
+        int statusMessageId,
+        string stickerSetName,
+        string downloadDirectory)
+    {
+        List<(string fileName, Exception error)> downloadErrors = new List<(string, Exception)>();
+        
+        try
+        {
+            // åˆ›å»ºä¸‹è½½ç›®å½•
+            Directory.CreateDirectory(downloadDirectory);
+
+            // è·å–è´´çº¸åŒ…ä¿¡æ¯
+            var stickerSet = await bot.GetStickerSet(stickerSetName);
+            
+            var statusBuilder = new StringBuilder()
+                .AppendLine("ğŸ“¦ è´´çº¸åŒ…ä¿¡æ¯:")
+                .AppendLine($"æ ‡é¢˜: {stickerSet.Title}")
+                .AppendLine($"è´´çº¸æ•°é‡: {stickerSet.Stickers.Length}")
+                .AppendLine($"ç±»å‹: {stickerSet.StickerType}")
+                .AppendLine($"ä¸‹è½½ä½ç½®: {Path.GetFullPath(downloadDirectory)}")
+                .AppendLine()
+                .Append("â¬‡ï¸ å¼€å§‹ä¸‹è½½è´´çº¸...");
+
+            await _messageService.EditMessageAsync(bot, msg.Chat.Id, statusMessageId, statusBuilder.ToString());
+
+            int downloadedCount = 0;
+            int totalCount = stickerSet.Stickers.Length;
+
+            // é€ä¸ªä¸‹è½½è´´çº¸
+            for (int i = 0; i < totalCount; i++)
+            {
+                var sticker = stickerSet.Stickers[i];
+                
+                try
+                {
+                    // æ›´æ–°è¿›åº¦çŠ¶æ€
+                    await _messageService.EditMessageAsync(bot, msg.Chat.Id, statusMessageId,
+                        $"[è¿›åº¦] æ­£åœ¨ä¸‹è½½ç¬¬ {i + 1}/{totalCount} ä¸ªè´´çº¸\nå·²å®Œæˆ: {downloadedCount}/{totalCount}");
+
+                    // è·å–è´´çº¸æ–‡ä»¶ä¿¡æ¯
+                    var fileInfo = await bot.GetFile(sticker.FileId);
+                    
+                    if (fileInfo == null)
+                    {
+                        downloadErrors.Add((GetFileName(i, sticker), new Exception("æ— æ³•è·å–æ–‡ä»¶ä¿¡æ¯")));
+                        continue;
+                    }
+
+                    // ç¡®å®šæ–‡ä»¶æ‰©å±•å
+                    string extension = GetStickerExtension(fileInfo);
+                    string fileName = $"{stickerSet.Name}_{i:D3}{extension}";
+                    string filePath = Path.Combine(downloadDirectory, fileName);
+
+                    // ä¸‹è½½æ–‡ä»¶
+                    await DownloadStickerFileAsync(bot, fileInfo.FilePath, filePath);
+                    
+                    downloadedCount++;
+                    
+                    // çŸ­æš‚å»¶è¿Ÿä»¥é¿å…è¯·æ±‚è¿‡äºé¢‘ç¹
+                    await Task.Delay(200);
+                }
+                catch (Exception ex)
+                {
+                    downloadErrors.Add((GetFileName(i, sticker), ex));
+                    _logger.LogWarning(ex, "ä¸‹è½½è´´çº¸å¤±è´¥: {Index}/{Total}", i + 1, totalCount);
+                }
+            }
+
+            // ç”Ÿæˆæœ€ç»ˆç»“æœæ¶ˆæ¯
+            var finalMessageBuilder = new StringBuilder()
+                .AppendLine("âœ… è´´çº¸åŒ…ä¸‹è½½å®Œæˆï¼")
+                .AppendLine()
+                .AppendLine($"ğŸ“ ä¸‹è½½ä½ç½®: {Path.GetFullPath(downloadDirectory)}")
+                .AppendLine($"ğŸ“ è´´çº¸åŒ…æ ‡é¢˜: {stickerSet.Title}")
+                .AppendLine($"ğŸ”¢ æ€»æ•°: {totalCount} ä¸ªè´´çº¸")
+                .AppendLine($"âœ… æˆåŠŸä¸‹è½½: {downloadedCount} ä¸ª")
+                .AppendLine($"âŒ å¤±è´¥: {downloadErrors.Count} ä¸ª");
+
+            if (downloadErrors.Any())
+            {
+                finalMessageBuilder.AppendLine().AppendLine("âš ï¸ å¤±è´¥çš„è´´çº¸:");
+                foreach (var (fileName, error) in downloadErrors.Take(5)) // åªæ˜¾ç¤ºå‰5ä¸ªé”™è¯¯
+                {
+                    finalMessageBuilder.AppendLine($"- {fileName}: {error.Message}");
+                }
+                if (downloadErrors.Count > 5)
+                {
+                    finalMessageBuilder.AppendLine($"- ...è¿˜æœ‰ {downloadErrors.Count - 5} ä¸ªé”™è¯¯");
+                }
+            }
+
+            await _messageService.EditMessageAsync(bot, msg.Chat.Id, statusMessageId, finalMessageBuilder.ToString());
+        }
+        catch (Exception ex)
+        {
+            var errorBuilder = new StringBuilder()
+                .AppendLine("âŒ ä¸‹è½½è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼š")
+                .AppendLine(ex.Message)
+                .AppendLine()
+                .Append("è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œç›®æ ‡æ–‡ä»¶å¤¹æƒé™åé‡è¯•ã€‚");
+
+            await _messageService.EditMessageAsync(bot, msg.Chat.Id, statusMessageId, errorBuilder.ToString());
+            _logger.LogError(ex, $"ä¸‹è½½è´´çº¸åŒ…æ—¶å‘ç”Ÿé”™è¯¯ - ç”¨æˆ·ID: {msg.From.Id}, è´´çº¸åŒ…: {stickerSetName}");
+        }
+    }
+
+    /// <summary>
+    /// ä¸‹è½½å•ä¸ªè´´çº¸æ–‡ä»¶
+    /// </summary>
+    private async Task DownloadStickerFileAsync(Bot bot, string filePath, string destinationPath)
+    {
+        try
+        {
+            // ä½¿ç”¨Telegram Bot APIä¸‹è½½æ–‡ä»¶
+            using var fileStream = new FileStream(destinationPath, FileMode.Create, FileAccess.Write);
+            await bot.DownloadFile(filePath, fileStream);
+        }
+        catch (Exception ex)
+        {
+            throw new Exception($"ä¸‹è½½æ–‡ä»¶å¤±è´¥: {ex.Message}", ex);
+        }
+    }
+
+    /// <summary>
+    /// æ ¹æ®æ–‡ä»¶ä¿¡æ¯è·å–è´´çº¸æ–‡ä»¶æ‰©å±•å
+    /// </summary>
+    private string GetStickerExtension(WTelegram.Types.File fileInfo)
+    {
+        if (fileInfo.MimeType?.Contains("video") == true)
+            return ".mp4";
+        else if (fileInfo.MimeType?.Contains("animated") == true)
+            return ".tgs"; // TelegramåŠ¨ç”»è´´çº¸æ ¼å¼
+        else
+            return ".png"; // é™æ€è´´çº¸é»˜è®¤ä½¿ç”¨PNGæ ¼å¼
+    }
+
+    /// <summary>
+    /// ç”Ÿæˆæ–‡ä»¶å
+    /// </summary>
+    private string GetFileName(int index, Sticker sticker)
+    {
+        return $"sticker_{index:D3}{(sticker.Emoji != null ? "_" + sticker.Emoji.Replace(" ", "") : "")}";
+    }
 }
\ No newline at end of file
diff --git a/src/Service/TelegramBotBackgroundService.cs b/src/Service/TelegramBotBackgroundService.cs
index 62455d8..d1efe23 100644
--- a/src/Service/TelegramBotBackgroundService.cs
+++ b/src/Service/TelegramBotBackgroundService.cs
@@ -76,6 +76,8 @@ public class TelegramBotBackgroundService : BackgroundService
         {
             new Telegram.Bot.Types.BotCommand { Command = "start", Description = "å¯åŠ¨æœºå™¨äºº" },
             new Telegram.Bot.Types.BotCommand { Command = "info", Description = "å…³äº" },
+            new Telegram.Bot.Types.BotCommand { Command = "download", Description = "ä¸‹è½½è´´çº¸åŒ…" },
+            new Telegram.Bot.Types.BotCommand { Command = "help_download", Description = "ä¸‹è½½å¸®åŠ©" },
         };
 
         foreach (var cmd in commands)
@@ -152,5 +154,13 @@ public class TelegramBotBackgroundService : BackgroundService
         {
             await _stickerService.SendStickerInfoAsync(bot, msg);
         }
+        else if (text.StartsWith("ä¸‹è½½#") || text.StartsWith("/download") || text.Contains("download"))
+        {
+            await _stickerService.HandleDownloadCommandAsync(bot, msg);
+        }
+        else if (text.StartsWith("/help_download") || text.Contains("å¸®åŠ©ä¸‹è½½"))
+        {
+            await _stickerService.SendDownloadInstructionsAsync(bot, msg);
+        }
     }
 }
\ No newline at end of file
-- 
2.43.0


From b87e78fb0ced2de6dd03a9cf8853bbe8537ee5f8 Mon Sep 17 00:00:00 2001
From: AI Assistant <ai-assistant@example.com>
Date: Fri, 17 Oct 2025 13:52:08 +0800
Subject: [PATCH 2/2] =?UTF-8?q?ci:=20=E5=A2=9E=E5=BC=BAGitHub=20Actions?=
 =?UTF-8?q?=E7=BC=96=E8=AF=91=E7=AE=A1=E9=81=93?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

- åœ¨æ„å»ºé˜¶æ®µæ·»åŠ åŸºç¡€ä»£ç è´¨é‡æ£€æŸ¥
- åŒ…æ‹¬ä¾èµ–æ¢å¤å’Œç¼–è¯‘éªŒè¯æ­¥éª¤
- æé«˜CI/CDç®¡é“çš„å¯é æ€§

Co-authored-by: dakou <dakou@iflow.cn>
---
 .github/workflows/build-release-docker.yml | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/.github/workflows/build-release-docker.yml b/.github/workflows/build-release-docker.yml
index 9b0ec73..a2b1034 100644
--- a/.github/workflows/build-release-docker.yml
+++ b/.github/workflows/build-release-docker.yml
@@ -67,6 +67,12 @@ jobs:
       - uses: actions/setup-dotnet@v4
         with:
           dotnet-version: ${{ env.DOTNET_VERSION }}
+      - name: Code Quality Checks
+        run: |
+          echo "Running basic code quality checks..."
+          dotnet restore "${{ env.PROJECT_PATH }}"
+          dotnet build "${{ env.PROJECT_PATH }}" --verbosity normal --no-restore
+          echo "âœ“ Basic compilation check passed"
       - name: Publish
         run: |
           dotnet publish "${{ env.PROJECT_PATH }}" \
-- 
2.43.0

